# -*- coding: utf-8 -*-
"""
LangGraph å·¥å…·è°ƒç”¨ Command ç¤ºä¾‹
å­¦ä¹ è¦ç‚¹ï¼šå·¥å…·è¿”å› Command æ›´æ–°çŠ¶æ€

è¿™ç§æ¨¡å¼çš„ä¼˜åŠ¿ï¼š
1. å·¥å…·å¯ä»¥ç›´æ¥æ›´æ–°å·¥ä½œæµçŠ¶æ€ï¼Œæ— éœ€é¢å¤–çš„çŠ¶æ€è½¬æ¢
2. å·¥å…·æ‰§è¡Œç»“æœå¯ä»¥ç«‹å³åæ˜ åœ¨å·¥ä½œæµä¸­
3. æ”¯æŒå¤æ‚çš„å·¥å…·é“¾å’ŒçŠ¶æ€ç®¡ç†
4. ä¾¿äºè°ƒè¯•å’Œè¿½è¸ªå·¥å…·æ‰§è¡Œè¿‡ç¨‹

é€‚ç”¨åœºæ™¯ï¼š
- æ•°æ®åº“æ“ä½œå·¥å…·ï¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯ã€æŸ¥è¯¢æ•°æ®
- API è°ƒç”¨å·¥å…·ï¼šè°ƒç”¨å¤–éƒ¨æœåŠ¡ã€è·å–å®æ—¶æ•°æ®
- æ–‡ä»¶æ“ä½œå·¥å…·ï¼šè¯»å†™æ–‡ä»¶ã€å¤„ç†æ–‡æ¡£
- è®¡ç®—å·¥å…·ï¼šæ‰§è¡Œå¤æ‚è®¡ç®—ã€æ•°æ®å¤„ç†

ä½œè€…: AI Assistant
æ¥æº: LangGraph å®˜æ–¹æ–‡æ¡£å­¦ä¹ 
"""

import os
from typing import TypedDict, List
from typing_extensions import Annotated

# LangGraph æ ¸å¿ƒç»„ä»¶
from langgraph.graph import StateGraph, START, END  # çŠ¶æ€å›¾ã€å¼€å§‹/ç»“æŸèŠ‚ç‚¹
from langgraph.graph.message import add_messages    # æ¶ˆæ¯åˆå¹¶å™¨
from langgraph.types import Command                  # Command å¯¹è±¡

import config  # é…ç½®æ–‡ä»¶

# è‡ªå®šä¹‰æ¨¡å‹é…ç½®
os.environ["OPENAI_API_BASE"] = config.base_url  # è®¾ç½® API åŸºç¡€åœ°å€
os.environ["OPENAI_API_KEY"] = config.api_key    # è®¾ç½® API å¯†é’¥
MODEL_NAME = config.model                         # è·å–æ¨¡å‹åç§°

# è·å–æ—¥å¿—å™¨
logger = config.logger  # ç”¨äºè®°å½•æ‰§è¡Œè¿‡ç¨‹å’Œè°ƒè¯•ä¿¡æ¯

# ============================================================================
# å·¥å…·è°ƒç”¨ - è¿”å› Command çš„å·¥å…·
# ============================================================================

class ToolState(TypedDict):
    """
    å·¥å…·çŠ¶æ€å®šä¹‰
    
    ç”¨äºæ¼”ç¤ºå·¥å…·è°ƒç”¨å’ŒçŠ¶æ€æ›´æ–°ï¼š
    - å·¥å…·æ‰§è¡Œç»“æœï¼šè®°å½•å·¥å…·çš„æ‰§è¡ŒçŠ¶æ€å’Œç»“æœ
    - çŠ¶æ€æ›´æ–°ï¼šé€šè¿‡ Command æ›´æ–°å·¥ä½œæµçŠ¶æ€
    - æ¶ˆæ¯å†å²ï¼šä½¿ç”¨ add_messages reducer åˆå¹¶æ¶ˆæ¯
    
    è¿™ç§æ¨¡å¼ç‰¹åˆ«é€‚ç”¨äºï¼š
    - æ•°æ®åº“æ“ä½œï¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯ã€æŸ¥è¯¢æ•°æ®
    - API è°ƒç”¨ï¼šè°ƒç”¨å¤–éƒ¨æœåŠ¡ã€è·å–æ•°æ®
    - çŠ¶æ€ç®¡ç†ï¼šç»´æŠ¤å·¥ä½œæµçš„å…¨å±€çŠ¶æ€
    """
    user_name: str       # ç”¨æˆ·åï¼Œç”±å·¥å…·æ›´æ–°
    messages: Annotated[List[str], add_messages]  # æ¶ˆæ¯å†å²ï¼Œä½¿ç”¨ reducer åˆå¹¶
    tool_results: List[str]  # å·¥å…·æ‰§è¡Œç»“æœï¼Œè®°å½•è°ƒç”¨äº†å“ªäº›å·¥å…·

def demo_tool_commands():
    """
    æ¼”ç¤ºå·¥å…·è°ƒç”¨ä¸­çš„ Command ä½¿ç”¨
    
    å±•ç¤ºå¦‚ä½•åˆ›å»ºè¿”å› Command çš„å·¥å…·ï¼Œ
    ä»¥åŠå¦‚ä½•åœ¨å·¥å…·ä¸­æ›´æ–°çŠ¶æ€
    
    è¿™ç§æ¨¡å¼çš„ä¼˜åŠ¿ï¼š
    1. å·¥å…·å¯ä»¥ç›´æ¥æ›´æ–°å·¥ä½œæµçŠ¶æ€ï¼Œæ— éœ€é¢å¤–çš„çŠ¶æ€è½¬æ¢
    2. å·¥å…·æ‰§è¡Œç»“æœå¯ä»¥ç«‹å³åæ˜ åœ¨å·¥ä½œæµä¸­
    3. æ”¯æŒå¤æ‚çš„å·¥å…·é“¾å’ŒçŠ¶æ€ç®¡ç†
    4. ä¾¿äºè°ƒè¯•å’Œè¿½è¸ªå·¥å…·æ‰§è¡Œè¿‡ç¨‹
    
    é€‚ç”¨åœºæ™¯ï¼š
    - æ•°æ®åº“æ“ä½œå·¥å…·ï¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯ã€æŸ¥è¯¢æ•°æ®
    - API è°ƒç”¨å·¥å…·ï¼šè°ƒç”¨å¤–éƒ¨æœåŠ¡ã€è·å–å®æ—¶æ•°æ®
    - æ–‡ä»¶æ“ä½œå·¥å…·ï¼šè¯»å†™æ–‡ä»¶ã€å¤„ç†æ–‡æ¡£
    - è®¡ç®—å·¥å…·ï¼šæ‰§è¡Œå¤æ‚è®¡ç®—ã€æ•°æ®å¤„ç†
    """
    logger.info("\n" + "="*60)
    logger.info("ğŸ”„ å·¥å…·è°ƒç”¨ Command æ¼”ç¤º")
    logger.info("å·¥å…·è¿”å› Command æ›´æ–°çŠ¶æ€")
    logger.info("ç‰¹ç‚¹ï¼šç›´æ¥çŠ¶æ€æ›´æ–°ã€å·¥å…·é“¾é›†æˆã€çŠ¶æ€è¿½è¸ª")
    logger.info("="*60)
    
    def update_user_name_tool(new_name: str) -> Command:
        """
        æ›´æ–°ç”¨æˆ·åçš„å·¥å…·
        
        è¿”å› Command æ¥æ›´æ–°çŠ¶æ€
        
        è¿™ä¸ªå·¥å…·æ¼”ç¤ºäº†å¦‚ä½•é€šè¿‡ Command ç›´æ¥æ›´æ–°å·¥ä½œæµçŠ¶æ€ï¼š
        1. æ›´æ–° user_name å­—æ®µ
        2. æ·»åŠ ä¸€æ¡æ¶ˆæ¯åˆ°æ¶ˆæ¯å†å²
        3. è®°å½•å·¥å…·æ‰§è¡Œç»“æœ
        
        Args:
            new_name: æ–°çš„ç”¨æˆ·å
            
        Returns:
            Command å¯¹è±¡ï¼ŒåŒ…å«çŠ¶æ€æ›´æ–°ä¿¡æ¯
        """
        logger.info(f"ğŸ”§ å·¥å…·: æ›´æ–°ç”¨æˆ·å -> {new_name}")
        
        return Command(
            update={
                "user_name": new_name,                    # ç›´æ¥æ›´æ–°ç”¨æˆ·å
                "messages": [f"ç”¨æˆ·åå·²æ›´æ–°ä¸º: {new_name}"], # æ·»åŠ æ¶ˆæ¯åˆ°å†å²
                "tool_results": ["update_user_name"]      # è®°å½•å·¥å…·æ‰§è¡Œ
            }
        )
    
    def get_user_info_tool() -> Command:
        """
        è·å–ç”¨æˆ·ä¿¡æ¯çš„å·¥å…·
        
        è¿”å› Command æ¥æ›´æ–°çŠ¶æ€
        """
        logger.info("ğŸ”§ å·¥å…·: è·å–ç”¨æˆ·ä¿¡æ¯")
        
        # æ¨¡æ‹Ÿè·å–ç”¨æˆ·ä¿¡æ¯
        user_info = "ç”¨æˆ·ä¿¡æ¯: æ´»è·ƒç”¨æˆ·ï¼ŒVIP ä¼šå‘˜"
        
        return Command(
            update={
                "messages": [f"è·å–åˆ°ç”¨æˆ·ä¿¡æ¯: {user_info}"],
                "tool_results": ["get_user_info"]
            }
        )
    
    def tool_execution_node(state: ToolState) -> ToolState:
        """
        å·¥å…·æ‰§è¡ŒèŠ‚ç‚¹
        
        æ¨¡æ‹Ÿå·¥å…·è°ƒç”¨å’ŒçŠ¶æ€æ›´æ–°
        
        è¿™ä¸ªèŠ‚ç‚¹æ¼”ç¤ºäº†å¦‚ä½•ï¼š
        1. è°ƒç”¨è¿”å› Command çš„å·¥å…·
        2. æ‰‹åŠ¨åº”ç”¨ Command çš„çŠ¶æ€æ›´æ–°
        3. å¤„ç†ä¸åŒç±»å‹çš„çŠ¶æ€å­—æ®µï¼ˆåˆ—è¡¨ vs æ ‡é‡ï¼‰
        
        åœ¨å®é™…åº”ç”¨ä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨ LangGraph çš„ ToolNode æˆ–
        create_react_agent æ¥è‡ªåŠ¨å¤„ç†å·¥å…·è°ƒç”¨å’ŒçŠ¶æ€æ›´æ–°ã€‚
        
        Args:
            state: å½“å‰å·¥ä½œæµçŠ¶æ€
            
        Returns:
            æ›´æ–°åçš„çŠ¶æ€
        """
        logger.info("ğŸ”§ å·¥å…·æ‰§è¡ŒèŠ‚ç‚¹: æ‰§è¡Œå·¥å…·è°ƒç”¨")
        
        # æ¨¡æ‹Ÿå·¥å…·è°ƒç”¨åºåˆ—
        tools_to_call = [
            ("update_user_name", "Alice"),  # æ›´æ–°ç”¨æˆ·åä¸º Alice
            ("get_user_info", None)         # è·å–ç”¨æˆ·ä¿¡æ¯
        ]
        
        for tool_name, tool_args in tools_to_call:
            logger.info(f"   ğŸ› ï¸ è°ƒç”¨å·¥å…·: {tool_name}")
            
            # æ ¹æ®å·¥å…·åç§°è°ƒç”¨ç›¸åº”çš„å·¥å…·
            if tool_name == "update_user_name":
                command = update_user_name_tool(tool_args)
            elif tool_name == "get_user_info":
                command = get_user_info_tool()
            
            # æ‰‹åŠ¨åº”ç”¨ Command çš„æ›´æ–°
            # åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒLangGraph ä¼šè‡ªåŠ¨å¤„ç†è¿™ä¸ªè¿‡ç¨‹
            for key, value in command["update"].items():
                if key in state:
                    if isinstance(value, list):
                        # å¯¹äºåˆ—è¡¨ç±»å‹ï¼Œä½¿ç”¨ reducer åˆå¹¶
                        if key == "messages":
                            state[key] = state[key] + value  # ä½¿ç”¨ add_messages reducer
                        else:
                            state[key] = state[key] + value  # ä½¿ç”¨ operator.add reducer
                    else:
                        # å¯¹äºå…¶ä»–ç±»å‹ï¼Œç›´æ¥æ›´æ–°
                        state[key] = value
        
        return {
            "messages": ["å·¥å…·æ‰§è¡Œå®Œæˆ"],      # æ·»åŠ å®Œæˆæ¶ˆæ¯
            "tool_results": ["tool_execution"] # è®°å½•èŠ‚ç‚¹æ‰§è¡Œ
        }
    
    # æ„å»ºå·¥ä½œæµ
    logger.info("ğŸ“‹ æ„å»ºå·¥å…·è°ƒç”¨å·¥ä½œæµ...")
    builder = StateGraph(ToolState)
    
    # æ·»åŠ èŠ‚ç‚¹
    builder.add_node("tool_execution", tool_execution_node)
    
    # è®¾ç½®è¾¹
    builder.add_edge(START, "tool_execution")
    builder.add_edge("tool_execution", END)
    
    # ç¼–è¯‘å›¾
    graph = builder.compile()
    logger.info("âœ… å·¥å…·è°ƒç”¨å·¥ä½œæµç¼–è¯‘å®Œæˆ")
    
    # æ‰§è¡Œå·¥ä½œæµ
    logger.info("\nğŸš€ æ‰§è¡Œå·¥å…·è°ƒç”¨å·¥ä½œæµ...")
    
    try:
        result = graph.invoke({
            "user_name": "",
            "messages": [],
            "tool_results": []
        })
        
        logger.info(f"ğŸ“Š æœ€ç»ˆç»“æœ: {result}")
        
    except Exception as e:
        logger.error(f"æ‰§è¡Œå·¥ä½œæµæ—¶å‡ºé”™: {e}")

# ============================================================================
# ä¸»æµ‹è¯•å‡½æ•°
# ============================================================================

def test_tool_commands():
    """
    æµ‹è¯•å·¥å…·è°ƒç”¨ Command åŠŸèƒ½çš„ä¸»å‡½æ•°
    
    å­¦ä¹ è¦ç‚¹ï¼š
    - å·¥å…·å¯ä»¥ç›´æ¥æ›´æ–°å·¥ä½œæµçŠ¶æ€ï¼Œæ— éœ€é¢å¤–çš„çŠ¶æ€è½¬æ¢
    - å·¥å…·æ‰§è¡Œç»“æœå¯ä»¥ç«‹å³åæ˜ åœ¨å·¥ä½œæµä¸­
    - æ”¯æŒå¤æ‚çš„å·¥å…·é“¾å’ŒçŠ¶æ€ç®¡ç†
    - ä¾¿äºè°ƒè¯•å’Œè¿½è¸ªå·¥å…·æ‰§è¡Œè¿‡ç¨‹
    
    é€‚ç”¨åœºæ™¯ï¼š
    - æ•°æ®åº“æ“ä½œå·¥å…·ï¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯ã€æŸ¥è¯¢æ•°æ®
    - API è°ƒç”¨å·¥å…·ï¼šè°ƒç”¨å¤–éƒ¨æœåŠ¡ã€è·å–å®æ—¶æ•°æ®
    - æ–‡ä»¶æ“ä½œå·¥å…·ï¼šè¯»å†™æ–‡ä»¶ã€å¤„ç†æ–‡æ¡£
    - è®¡ç®—å·¥å…·ï¼šæ‰§è¡Œå¤æ‚è®¡ç®—ã€æ•°æ®å¤„ç†
    """
    logger.info("ğŸ¯ æµ‹è¯• LangGraph å·¥å…·è°ƒç”¨ Command åŠŸèƒ½")
    logger.info(f"æ¨¡å‹é…ç½®: {MODEL_NAME}")
    logger.info(f"API åœ°å€: {os.environ.get('OPENAI_API_BASE', 'é»˜è®¤åœ°å€')}")
    logger.info("ğŸ“š å­¦ä¹ ç›®æ ‡ï¼šæŒæ¡å·¥å…·è¿”å› Command æ›´æ–°çŠ¶æ€çš„æ–¹å¼")
    
    # æ¼”ç¤ºå·¥å…·è°ƒç”¨
    demo_tool_commands()
    
    logger.info("\n" + "="*60)
    logger.info("ğŸ‰ å·¥å…·è°ƒç”¨ Command æ¼”ç¤ºå®Œæˆï¼")
    logger.info("ğŸ“‹ æ€»ç»“ï¼šå·¥å…·å¯ä»¥ç›´æ¥æ›´æ–°å·¥ä½œæµçŠ¶æ€ï¼Œå®ç°æ— ç¼é›†æˆ")
    logger.info("ğŸ”— ç›¸å…³æ¦‚å¿µï¼šå·¥å…·é›†æˆã€çŠ¶æ€ç®¡ç†ã€Command å¯¹è±¡ã€reducer")
    logger.info("="*60)

if __name__ == "__main__":
    test_tool_commands() 