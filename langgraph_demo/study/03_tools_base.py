# -*- coding: utf-8 -*-
"""
LangGraph å·¥å…·é›†æˆç¤ºä¾‹ - åŸºäº Context7 æ–‡æ¡£çš„æœ€ä½³å®è·µ
å­¦ä¹ è¦ç‚¹ï¼šå·¥å…·å®šä¹‰ã€å·¥å…·è°ƒç”¨ã€çŠ¶æ€æ‰©å±•

ä½œè€…: AI Assistant
æ¥æº: LangGraph å®˜æ–¹æ–‡æ¡£å­¦ä¹ 

æ ¸å¿ƒæ¦‚å¿µè¯´æ˜ï¼š
1. å·¥å…·ï¼ˆToolsï¼‰ï¼šå°è£…äº†å¯è°ƒç”¨å‡½æ•°å’Œè¾“å…¥æ¨¡å¼ï¼Œè®©æ¨¡å‹èƒ½å¤Ÿæ™ºèƒ½å†³å®šä½•æ—¶è°ƒç”¨å·¥å…·
2. å·¥ä½œæµï¼ˆWorkflowï¼‰ï¼šå®šä¹‰äº†èŠ‚ç‚¹é—´çš„æ‰§è¡Œé¡ºåºï¼Œé€šè¿‡ StateGraph æ„å»º
3. çŠ¶æ€ï¼ˆStateï¼‰ï¼šèŠ‚ç‚¹é—´ä¼ é€’æ•°æ®çš„å®¹å™¨ï¼Œä½¿ç”¨ TypedDict å®šä¹‰
4. è·¯ç”±ï¼ˆRoutingï¼‰ï¼šæ ¹æ®æ¡ä»¶å†³å®šå·¥ä½œæµçš„æ‰§è¡Œè·¯å¾„

æ¶æ„è®¾è®¡ï¼š
ç”¨æˆ·è¾“å…¥ â†’ æ¨¡å‹è°ƒç”¨ â†’ æ¡ä»¶è·¯ç”± â†’ å·¥å…·æ‰§è¡Œ â†’ è¿”å›æ¨¡å‹ â†’ æœ€ç»ˆå“åº”
"""

import os
import json
import requests
from typing import TypedDict, List
from typing_extensions import Annotated

# ============================================================================
# LangGraph æ ¸å¿ƒç»„ä»¶å¯¼å…¥
# ============================================================================
# StateGraph: ç”¨äºæ„å»ºçŠ¶æ€å›¾å·¥ä½œæµ
# START/END: å·¥ä½œæµçš„å¼€å§‹å’Œç»“æŸèŠ‚ç‚¹
# add_messages: è‡ªåŠ¨åˆå¹¶æ¶ˆæ¯çš„æ³¨è§£
# ToolNode: ä¸“é—¨ç”¨äºæ‰§è¡Œå·¥å…·çš„èŠ‚ç‚¹
# create_react_agent: åˆ›å»º ReAct æ™ºèƒ½ä½“çš„é¢„æ„å»ºå‡½æ•°
from langgraph.graph import StateGraph, START, END
from langgraph.graph.message import add_messages
from langgraph.prebuilt import ToolNode, create_react_agent

# ============================================================================
# LangChain ç»„ä»¶å¯¼å…¥
# ============================================================================
# HumanMessage/AIMessage/SystemMessage: ä¸åŒç±»å‹çš„æ¶ˆæ¯
# tool: è£…é¥°å™¨ï¼Œç”¨äºå°†å‡½æ•°æ³¨å†Œä¸ºå·¥å…·
# ChatOpenAI: OpenAI èŠå¤©æ¨¡å‹
# ChatPromptTemplate: èŠå¤©æç¤ºæ¨¡æ¿
# MessagesPlaceholder: æ¶ˆæ¯å ä½ç¬¦
from langchain_core.messages import HumanMessage, AIMessage, SystemMessage
from langchain_core.tools import tool
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder

import config

# ============================================================================
# ç¯å¢ƒé…ç½®å’Œæ¨¡å‹åˆå§‹åŒ–
# ============================================================================
# è®¾ç½® OpenAI API é…ç½®
os.environ["OPENAI_API_BASE"] = config.base_url
os.environ["OPENAI_API_KEY"] = config.api_key
MODEL_NAME = config.model

# è·å–æ—¥å¿—å™¨
logger = config.logger

# åˆå§‹åŒ–è¯­è¨€æ¨¡å‹
# temperature=0.1: ä½æ¸©åº¦ç¡®ä¿å›ç­”çš„ä¸€è‡´æ€§
# max_tokens=1000: é™åˆ¶è¾“å‡ºé•¿åº¦ï¼Œé¿å…è¿‡é•¿å“åº”
llm = ChatOpenAI(
    model=MODEL_NAME,
    temperature=0.1,
    max_tokens=1000
)

# ============================================================================
# å·¥å…·å®šä¹‰ - åŸºäº Context7 æ–‡æ¡£çš„æœ€ä½³å®è·µ
# ============================================================================
# å·¥å…·æ˜¯ LangGraph ä¸­æ‰©å±•åŠŸèƒ½çš„æ ¸å¿ƒç»„ä»¶
# æ¯ä¸ªå·¥å…·éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°ï¼Œä½¿ç”¨ @tool è£…é¥°å™¨æ³¨å†Œ
# å·¥å…·å¯ä»¥è¢«å·¥ä½œæµä¸­çš„èŠ‚ç‚¹è°ƒç”¨ï¼Œå®ç°å¤æ‚çš„åŠŸèƒ½

@tool
def get_weather(city: str) -> str:
    """
    è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯
    
    åŠŸèƒ½è¯´æ˜ï¼š
    - æ¨¡æ‹Ÿå¤©æ°”æŸ¥è¯¢æœåŠ¡
    - æ”¯æŒåŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·ã€æ·±åœ³å››ä¸ªåŸå¸‚
    - è¿”å›æ¸©åº¦ã€å¤©æ°”çŠ¶å†µã€æ¹¿åº¦ã€é£åŠ›ç­‰è¯¦ç»†ä¿¡æ¯
    
    Args:
        city: åŸå¸‚åç§°
        
    Returns:
        å¤©æ°”ä¿¡æ¯å­—ç¬¦ä¸²ï¼Œæ ¼å¼ï¼šåŸå¸‚å¤©æ°”: çŠ¶å†µ, æ¸©åº¦, æ¹¿åº¦, é£åŠ›
    """
    logger.info(f"ğŸŒ¤ï¸ è°ƒç”¨å¤©æ°”å·¥å…·ï¼ŒæŸ¥è¯¢åŸå¸‚: {city}")
    
    # æ¨¡æ‹Ÿå¤©æ°”æ•°æ®åº“ - åœ¨å®é™…åº”ç”¨ä¸­ä¼šè°ƒç”¨çœŸå®çš„å¤©æ°”API
    weather_data = {
        "åŒ—äº¬": {
            "temperature": "25Â°C",
            "condition": "æ™´å¤©",
            "humidity": "45%",
            "wind": "ä¸œåŒ—é£ 3çº§"
        },
        "ä¸Šæµ·": {
            "temperature": "28Â°C", 
            "condition": "å¤šäº‘",
            "humidity": "65%",
            "wind": "ä¸œå—é£ 4çº§"
        },
        "å¹¿å·": {
            "temperature": "30Â°C",
            "condition": "å°é›¨", 
            "humidity": "80%",
            "wind": "å—é£ 2çº§"
        },
        "æ·±åœ³": {
            "temperature": "29Â°C",
            "condition": "æ™´å¤©",
            "humidity": "55%", 
            "wind": "ä¸œå—é£ 3çº§"
        }
    }
    
    # æŸ¥è¯¢å¤©æ°”æ•°æ®å¹¶æ ¼å¼åŒ–è¿”å›
    if city in weather_data:
        data = weather_data[city]
        result = f"{city}å¤©æ°”: {data['condition']}, æ¸©åº¦{data['temperature']}, æ¹¿åº¦{data['humidity']}, {data['wind']}"
    else:
        result = f"æŠ±æ­‰ï¼Œæ²¡æœ‰æ‰¾åˆ° {city} çš„å¤©æ°”ä¿¡æ¯"
    
    logger.info(f"å¤©æ°”å·¥å…·è¿”å›: {result}")
    return result

@tool
def calculate_math(expression: str) -> str:
    """
    è®¡ç®—æ•°å­¦è¡¨è¾¾å¼
    
    åŠŸèƒ½è¯´æ˜ï¼š
    - æ”¯æŒåŸºæœ¬çš„æ•°å­¦è¿ç®—ï¼šåŠ å‡ä¹˜é™¤ã€æ‹¬å·
    - ä½¿ç”¨ eval() å‡½æ•°æ‰§è¡Œè®¡ç®—ï¼ˆæ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹æ³•ï¼‰
    - åŒ…å«é”™è¯¯å¤„ç†æœºåˆ¶
    
    Args:
        expression: æ•°å­¦è¡¨è¾¾å¼ï¼Œå¦‚ "2 + 3 * 4"
        
    Returns:
        è®¡ç®—ç»“æœå­—ç¬¦ä¸²ï¼Œæ ¼å¼ï¼šè®¡ç®—ç»“æœ: è¡¨è¾¾å¼ = ç»“æœ
    """
    logger.info(f"ğŸ§® è°ƒç”¨æ•°å­¦è®¡ç®—å·¥å…·ï¼Œè¡¨è¾¾å¼: {expression}")
    
    try:
        # æ‰§è¡Œæ•°å­¦è®¡ç®—
        # æ³¨æ„ï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼Œåº”è¯¥ä½¿ç”¨æ›´å®‰å…¨çš„è®¡ç®—æ–¹æ³•ï¼Œå¦‚ ast.literal_eval
        result = eval(expression)
        response = f"è®¡ç®—ç»“æœ: {expression} = {result}"
    except Exception as e:
        # å¤„ç†è®¡ç®—é”™è¯¯
        response = f"è®¡ç®—é”™è¯¯: {str(e)}"
    
    logger.info(f"æ•°å­¦å·¥å…·è¿”å›: {response}")
    return response

@tool
def search_web(query: str) -> str:
    """
    ç½‘ç»œæœç´¢å·¥å…·
    
    åŠŸèƒ½è¯´æ˜ï¼š
    - æ¨¡æ‹Ÿç½‘ç»œæœç´¢åŠŸèƒ½
    - æ”¯æŒå…³é”®è¯åŒ¹é…æœç´¢
    - è¿”å›æ ¼å¼åŒ–çš„æœç´¢ç»“æœ
    
    Args:
        query: æœç´¢æŸ¥è¯¢
        
    Returns:
        æœç´¢ç»“æœå­—ç¬¦ä¸²ï¼ŒåŒ…å«åŒ¹é…çš„ç›¸å…³ä¿¡æ¯
    """
    logger.info(f"ğŸ” è°ƒç”¨ç½‘ç»œæœç´¢å·¥å…·ï¼ŒæŸ¥è¯¢: {query}")
    
    # æ¨¡æ‹Ÿæœç´¢æ•°æ®åº“ - åœ¨å®é™…åº”ç”¨ä¸­ä¼šè°ƒç”¨çœŸå®çš„æœç´¢å¼•æ“API
    search_results = {
        "äººå·¥æ™ºèƒ½": [
            "äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯",
            "æœºå™¨å­¦ä¹ æ˜¯AIçš„é‡è¦æŠ€æœ¯",
            "æ·±åº¦å­¦ä¹ åœ¨å›¾åƒè¯†åˆ«æ–¹é¢è¡¨ç°ä¼˜å¼‚"
        ],
        "LangGraph": [
            "LangGraphæ˜¯æ„å»ºæ™ºèƒ½ä½“åº”ç”¨çš„æ¡†æ¶",
            "æ”¯æŒçŠ¶æ€ç®¡ç†å’Œæ¡ä»¶è·¯ç”±",
            "å¯ä»¥åˆ›å»ºå¤æ‚çš„å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ"
        ],
        "Python": [
            "Pythonæ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€",
            "å¹¿æ³›åº”ç”¨äºæ•°æ®ç§‘å­¦å’ŒAI",
            "è¯­æ³•ç®€æ´ï¼Œæ˜“äºå­¦ä¹ "
        ]
    }
    
    # æ‰§è¡Œæœç´¢åŒ¹é…
    results = []
    for key, value in search_results.items():
        if key.lower() in query.lower():
            results.extend(value)
    
    # æ ¼å¼åŒ–æœç´¢ç»“æœ
    if results:
        response = f"æœç´¢ç»“æœ:\n" + "\n".join([f"- {result}" for result in results[:3]])
    else:
        response = f"æ²¡æœ‰æ‰¾åˆ°å…³äº '{query}' çš„ç›¸å…³ä¿¡æ¯"
    
    logger.info(f"æœç´¢å·¥å…·è¿”å›: {response}")
    return response

@tool
def translate_text(text: str, target_language: str = "ä¸­æ–‡") -> str:
    """
    æ–‡æœ¬ç¿»è¯‘å·¥å…·
    
    åŠŸèƒ½è¯´æ˜ï¼š
    - æ”¯æŒä¸­è‹±æ–‡äº’è¯‘
    - ä½¿ç”¨é¢„å®šä¹‰çš„ç¿»è¯‘è¯å…¸
    - å¯æ‰©å±•æ”¯æŒæ›´å¤šè¯­è¨€
    
    Args:
        text: è¦ç¿»è¯‘çš„æ–‡æœ¬
        target_language: ç›®æ ‡è¯­è¨€ï¼ˆé»˜è®¤ä¸ºä¸­æ–‡ï¼‰
        
    Returns:
        ç¿»è¯‘ç»“æœå­—ç¬¦ä¸²ï¼Œæ ¼å¼ï¼šç¿»è¯‘ç»“æœ: åŸæ–‡ â†’ è¯‘æ–‡
    """
    logger.info(f"ğŸŒ è°ƒç”¨ç¿»è¯‘å·¥å…·ï¼Œæ–‡æœ¬: {text}, ç›®æ ‡è¯­è¨€: {target_language}")
    
    # ç¿»è¯‘è¯å…¸ - åœ¨å®é™…åº”ç”¨ä¸­ä¼šè°ƒç”¨çœŸå®çš„ç¿»è¯‘API
    translations = {
        "hello": "ä½ å¥½",
        "ä½ å¥½": "hello",
        "world": "ä¸–ç•Œ",
        "ä¸–ç•Œ": "world",
        "python": "Pythonç¼–ç¨‹è¯­è¨€",
        "ai": "äººå·¥æ™ºèƒ½",
        "äººå·¥æ™ºèƒ½": "artificial intelligence"
    }
    
    # æ‰§è¡Œç¿»è¯‘
    text_lower = text.lower()
    if text_lower in translations:
        result = f"ç¿»è¯‘ç»“æœ: {text} â†’ {translations[text_lower]}"
    else:
        result = f"æŠ±æ­‰ï¼Œæ— æ³•ç¿»è¯‘ '{text}' åˆ° {target_language}"
    
    logger.info(f"ç¿»è¯‘å·¥å…·è¿”å›: {result}")
    return result

@tool
def ask_llm(question: str, context: str = "") -> str:
    """
    å‘å¤§è¯­è¨€æ¨¡å‹æé—®
    
    åŠŸèƒ½è¯´æ˜ï¼š
    - ä½¿ç”¨é…ç½®çš„è¯­è¨€æ¨¡å‹å›ç­”é—®é¢˜
    - æ”¯æŒä¸Šä¸‹æ–‡ä¿¡æ¯
    - åŒ…å«é”™è¯¯å¤„ç†æœºåˆ¶
    
    Args:
        question: é—®é¢˜å†…å®¹
        context: ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
        
    Returns:
        æ¨¡å‹å›ç­”å­—ç¬¦ä¸²
    """
    logger.info(f"ğŸ¤– è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ï¼Œé—®é¢˜: {question}")
    
    try:
        # æ„å»ºæ¶ˆæ¯åˆ—è¡¨
        messages = []
        
        # æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ä¸Šä¸‹æ–‡ï¼‰
        if context:
            messages.append(SystemMessage(content=f"ä¸Šä¸‹æ–‡ä¿¡æ¯: {context}"))
        
        # æ·»åŠ ç”¨æˆ·é—®é¢˜
        messages.append(HumanMessage(content=question))
        
        # è°ƒç”¨è¯­è¨€æ¨¡å‹
        response = llm.invoke(messages)
        result = response.content
        
        logger.info(f"å¤§è¯­è¨€æ¨¡å‹å›ç­”: {result}")
        return result
        
    except Exception as e:
        # å¤„ç†è°ƒç”¨é”™è¯¯
        error_msg = f"è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹å¤±è´¥: {str(e)}"
        logger.error(error_msg)
        return error_msg

@tool
def analyze_text(text: str, analysis_type: str = "general") -> str:
    """
    æ–‡æœ¬åˆ†æå·¥å…·
    
    åŠŸèƒ½è¯´æ˜ï¼š
    - æ”¯æŒå¤šç§åˆ†æç±»å‹ï¼šæƒ…æ„Ÿåˆ†æã€æ‘˜è¦ç”Ÿæˆã€å…³é”®è¯æå–
    - ä½¿ç”¨è¯­è¨€æ¨¡å‹è¿›è¡Œåˆ†æ
    - å¯æ‰©å±•æ”¯æŒæ›´å¤šåˆ†æåŠŸèƒ½
    
    Args:
        text: è¦åˆ†æçš„æ–‡æœ¬
        analysis_type: åˆ†æç±»å‹ï¼ˆgeneral, sentiment, summary, keywordsï¼‰
        
    Returns:
        åˆ†æç»“æœå­—ç¬¦ä¸²
    """
    logger.info(f"ğŸ“Š è°ƒç”¨æ–‡æœ¬åˆ†æå·¥å…·ï¼Œæ–‡æœ¬: {text[:50]}..., åˆ†æç±»å‹: {analysis_type}")
    
    try:
        # æ ¹æ®åˆ†æç±»å‹æ„å»ºæç¤º
        if analysis_type == "sentiment":
            prompt = f"è¯·åˆ†æä»¥ä¸‹æ–‡æœ¬çš„æƒ…æ„Ÿå€¾å‘ï¼ˆç§¯æã€æ¶ˆææˆ–ä¸­æ€§ï¼‰ï¼š\n{text}"
        elif analysis_type == "summary":
            prompt = f"è¯·ä¸ºä»¥ä¸‹æ–‡æœ¬ç”Ÿæˆä¸€ä¸ªç®€æ´çš„æ‘˜è¦ï¼š\n{text}"
        elif analysis_type == "keywords":
            prompt = f"è¯·ä»ä»¥ä¸‹æ–‡æœ¬ä¸­æå–å…³é”®è¯ï¼š\n{text}"
        else:
            prompt = f"è¯·å¯¹ä»¥ä¸‹æ–‡æœ¬è¿›è¡Œä¸€èˆ¬æ€§åˆ†æï¼š\n{text}"
        
        # è°ƒç”¨è¯­è¨€æ¨¡å‹è¿›è¡Œåˆ†æ
        messages = [HumanMessage(content=prompt)]
        response = llm.invoke(messages)
        
        # æ ¼å¼åŒ–åˆ†æç»“æœ
        result = f"æ–‡æœ¬åˆ†æç»“æœï¼ˆ{analysis_type}ï¼‰:\n{response.content}"
        
        logger.info(f"æ–‡æœ¬åˆ†æç»“æœ: {result}")
        return result
        
    except Exception as e:
        # å¤„ç†åˆ†æé”™è¯¯
        error_msg = f"æ–‡æœ¬åˆ†æå¤±è´¥: {str(e)}"
        logger.error(error_msg)
        return error_msg

# åˆ›å»ºå·¥å…·åˆ—è¡¨ - å°†æ‰€æœ‰å·¥å…·ç»„ç»‡åœ¨ä¸€èµ·ä¾›å·¥ä½œæµä½¿ç”¨
tools = [
    get_weather,
    calculate_math,
    search_web,
    translate_text,
    ask_llm,
    analyze_text
]

# ============================================================================
# çŠ¶æ€å®šä¹‰
# ============================================================================
# çŠ¶æ€æ˜¯ LangGraph å·¥ä½œæµä¸­èŠ‚ç‚¹é—´ä¼ é€’æ•°æ®çš„å®¹å™¨
# ä½¿ç”¨ TypedDict å®šä¹‰çŠ¶æ€ç»“æ„ï¼Œç¡®ä¿ç±»å‹å®‰å…¨

class ToolState(TypedDict):
    """
    å·¥å…·çŠ¶æ€ - åŒ…å«å·¥å…·è°ƒç”¨ç»“æœå’Œå¤„ç†ä¿¡æ¯
    
    çŠ¶æ€å­—æ®µè¯´æ˜:
    - messages: æ¶ˆæ¯å†å²ï¼Œä½¿ç”¨ add_messages æ³¨è§£è‡ªåŠ¨åˆå¹¶æ¶ˆæ¯
    - user_input: ç”¨æˆ·åŸå§‹è¾“å…¥
    - tool_results: å·¥å…·æ‰§è¡Œç»“æœåˆ—è¡¨
    - selected_tools: é€‰æ‹©çš„å·¥å…·åç§°åˆ—è¡¨
    - final_response: æœ€ç»ˆåˆæˆçš„å“åº”
    """
    # æ¶ˆæ¯å†å²ï¼šä½¿ç”¨ add_messages æ³¨è§£è‡ªåŠ¨åˆå¹¶æ¶ˆæ¯
    messages: Annotated[List[HumanMessage | AIMessage], add_messages]
    # ç”¨æˆ·è¾“å…¥ï¼šåŸå§‹çš„ç”¨æˆ·è¯·æ±‚
    user_input: str
    # å·¥å…·ç»“æœï¼šå­˜å‚¨å„ä¸ªå·¥å…·çš„æ‰§è¡Œç»“æœ
    tool_results: List[str]
    # é€‰æ‹©å·¥å…·ï¼šå­˜å‚¨å·¥å…·é€‰æ‹©èŠ‚ç‚¹é€‰æ‹©çš„å·¥å…·åˆ—è¡¨
    selected_tools: List[str]
    # æœ€ç»ˆå“åº”ï¼šå­˜å‚¨å“åº”åˆæˆèŠ‚ç‚¹ç”Ÿæˆçš„æœ€ç»ˆå›ç­”
    final_response: str

# ============================================================================
# å·¥ä½œæµèŠ‚ç‚¹ - åŸºäº Context7 æ–‡æ¡£çš„æœ€ä½³å®è·µ
# ============================================================================
# èŠ‚ç‚¹æ˜¯å·¥ä½œæµä¸­çš„å¤„ç†å•å…ƒï¼Œæ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œç‰¹å®šçš„ä»»åŠ¡
# åŸºäº Context7 æ–‡æ¡£ï¼Œä½¿ç”¨æ ‡å‡†çš„ ReAct æ¨¡å¼

def route_tools(state: ToolState):
    """
    è·¯ç”±å‡½æ•° - æ ¹æ®æ¶ˆæ¯å†…å®¹å†³å®šæ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·
    
    åŠŸèƒ½è¯´æ˜ï¼š
    - æ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å¦åŒ…å«å·¥å…·è°ƒç”¨
    - å¦‚æœæœ‰å·¥å…·è°ƒç”¨ï¼Œè·¯ç”±åˆ°å·¥å…·æ‰§è¡ŒèŠ‚ç‚¹
    - å¦‚æœæ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œç»“æŸå·¥ä½œæµ
    - ä½¿ç”¨æ¡ä»¶è·¯ç”±æ§åˆ¶å·¥ä½œæµæ‰§è¡Œ
    - æ”¯æŒåŠ¨æ€å·¥å…·è°ƒç”¨å†³ç­–
    """
    # è·å–æ¶ˆæ¯åˆ—è¡¨
    messages = state.get("messages", [])
    if not messages:
        return END
    
    # æ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯
    last_message = messages[-1]
    
    # å¦‚æœæœ€åä¸€æ¡æ¶ˆæ¯åŒ…å«å·¥å…·è°ƒç”¨ï¼Œåˆ™è·¯ç”±åˆ°å·¥å…·èŠ‚ç‚¹
    if hasattr(last_message, "tool_calls") and len(last_message.tool_calls) > 0:
        return "tools"
    
    # å¦åˆ™ç»“æŸå·¥ä½œæµ
    return END

def call_model(state: ToolState) -> ToolState:
    """
    è°ƒç”¨æ¨¡å‹èŠ‚ç‚¹ - ä½¿ç”¨ create_react_agent å’Œè‡ªå®šä¹‰æç¤ºè¯
    
    åŠŸèƒ½è¯´æ˜ï¼š
    - ä½¿ç”¨ LangGraph çš„ create_react_agent åˆ›å»ºæ™ºèƒ½ä½“
    - æ·»åŠ è‡ªå®šä¹‰æç¤ºè¯æ¥ä¼˜åŒ–å·¥å…·é€‰æ‹©é€»è¾‘
    - å°†ç”¨æˆ·è¾“å…¥ä¼ é€’ç»™æ™ºèƒ½ä½“
    - è¿”å›æ™ºèƒ½ä½“çš„å“åº”æ¶ˆæ¯
    - ç¡®ä¿åªè°ƒç”¨ç›¸å…³çš„å·¥å…·
    """
    logger.info("ğŸ§  è°ƒç”¨æ¨¡å‹èŠ‚ç‚¹æ­£åœ¨å·¥ä½œ...")
    
    # è·å–ç”¨æˆ·è¾“å…¥
    user_input = state["user_input"]
    
    # è®°å½•ç”¨æˆ·è¾“å…¥
    logger.info(f"ğŸ“ ç”¨æˆ·è¾“å…¥: {user_input}")
    
    # åˆ›å»ºè‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯ï¼Œä¼˜åŒ–å·¥å…·é€‰æ‹©é€»è¾‘
    custom_prompt = """ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ·çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„å·¥å…·æ¥å¸®åŠ©ç”¨æˆ·ã€‚

é‡è¦åŸåˆ™ï¼š
1. ä»”ç»†åˆ†æç”¨æˆ·çš„é—®é¢˜ï¼Œç†è§£å…¶çœŸå®æ„å›¾
2. åªé€‰æ‹©æœ€ç›¸å…³ã€æœ€åˆé€‚çš„å·¥å…·
3. é¿å…è°ƒç”¨ä¸ç›¸å…³çš„å·¥å…·
4. ä¼˜å…ˆé€‰æ‹©ä¸“é—¨é’ˆå¯¹ç”¨æˆ·éœ€æ±‚çš„å·¥å…·

å·¥å…·é€‰æ‹©ç­–ç•¥ï¼š

get_weather å·¥å…·ï¼š
- ç”¨é€”ï¼šæŸ¥è¯¢å¤©æ°”ä¿¡æ¯
- é€‚ç”¨åœºæ™¯ï¼šç”¨æˆ·è¯¢é—®å¤©æ°”ã€æ¸©åº¦ã€æ°”å€™ã€å¤©æ°”çŠ¶å†µç­‰
- å…³é”®è¯ï¼šå¤©æ°”ã€æ¸©åº¦ã€ä¸‹é›¨ã€æ™´å¤©ã€æ°”å€™ã€å¤©æ°”é¢„æŠ¥ç­‰

calculate_math å·¥å…·ï¼š
- ç”¨é€”ï¼šè¿›è¡Œæ•°å­¦è®¡ç®—
- é€‚ç”¨åœºæ™¯ï¼šç”¨æˆ·éœ€è¦è¿›è¡Œæ•°å­—è¿ç®—ã€æ•°å­¦è®¡ç®—ã€å…¬å¼è®¡ç®—ç­‰
- å…³é”®è¯ï¼šè®¡ç®—ã€æ•°å­¦ã€æ•°å­—ã€è¿ç®—ã€å…¬å¼ã€åŠ å‡ä¹˜é™¤ç­‰

search_web å·¥å…·ï¼š
- ç”¨é€”ï¼šæœç´¢å’ŒæŸ¥æ‰¾ä¿¡æ¯
- é€‚ç”¨åœºæ™¯ï¼šç”¨æˆ·æƒ³è¦äº†è§£ã€æœç´¢ã€æŸ¥æ‰¾ã€è·å–ä¿¡æ¯ç­‰
- å…³é”®è¯ï¼šäº†è§£ã€æœç´¢ã€æŸ¥æ‰¾ã€ä¿¡æ¯ã€èµ„æ–™ã€ä»‹ç»ã€ä»€ä¹ˆæ˜¯ç­‰

translate_text å·¥å…·ï¼š
- ç”¨é€”ï¼šç¿»è¯‘æ–‡æœ¬å†…å®¹
- é€‚ç”¨åœºæ™¯ï¼šç”¨æˆ·æ˜ç¡®è¦æ±‚ç¿»è¯‘æ–‡æœ¬ã€å•è¯ã€çŸ­è¯­ç­‰
- å…³é”®è¯ï¼šç¿»è¯‘ã€è‹±æ–‡ã€ä¸­æ–‡ã€è¯­è¨€è½¬æ¢ç­‰

ask_llm å·¥å…·ï¼š
- ç”¨é€”ï¼šæ·±åº¦æ€è€ƒå’Œå¤æ‚é—®é¢˜è§£ç­”
- é€‚ç”¨åœºæ™¯ï¼šç”¨æˆ·è¯¢é—®éœ€è¦æ·±åº¦æ€è€ƒã€è§£é‡Šã€åˆ†æçš„é—®é¢˜
- å…³é”®è¯ï¼šè§£é‡Šã€ä»€ä¹ˆæ˜¯ã€ä¸ºä»€ä¹ˆã€å¦‚ä½•ã€åˆ†æã€æ€è€ƒç­‰

analyze_text å·¥å…·ï¼š
- ç”¨é€”ï¼šæ–‡æœ¬åˆ†æï¼ˆæƒ…æ„Ÿã€æ‘˜è¦ã€å…³é”®è¯ç­‰ï¼‰
- é€‚ç”¨åœºæ™¯ï¼šç”¨æˆ·è¦æ±‚åˆ†ææ–‡æœ¬å†…å®¹ã€æƒ…æ„Ÿã€æ‘˜è¦ã€å…³é”®è¯ç­‰
- å…³é”®è¯ï¼šåˆ†æã€æƒ…æ„Ÿã€æ‘˜è¦ã€å…³é”®è¯ã€æ€»ç»“ã€æ–‡æœ¬åˆ†æç­‰

å¯ç”¨å·¥å…·ï¼š
- get_weather: æŸ¥è¯¢æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯
- calculate_math: è®¡ç®—æ•°å­¦è¡¨è¾¾å¼
- search_web: æœç´¢ç½‘ç»œä¿¡æ¯
- translate_text: ç¿»è¯‘æ–‡æœ¬
- ask_llm: ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹å›ç­”é—®é¢˜
- analyze_text: åˆ†ææ–‡æœ¬ï¼ˆæƒ…æ„Ÿã€æ‘˜è¦ã€å…³é”®è¯ç­‰ï¼‰

å†³ç­–æµç¨‹ï¼š
1. ä»”ç»†é˜…è¯»ç”¨æˆ·çš„é—®é¢˜
2. è¯†åˆ«é—®é¢˜çš„æ ¸å¿ƒæ„å›¾å’Œå…³é”®è¯
3. æ ¹æ®å·¥å…·ç”¨é€”å’Œé€‚ç”¨åœºæ™¯è¿›è¡ŒåŒ¹é…
4. é€‰æ‹©æœ€åˆé€‚çš„å·¥å…·
5. é¿å…è°ƒç”¨ä¸ç›¸å…³çš„å·¥å…·

è¯·æ ¹æ®ç”¨æˆ·é—®é¢˜çš„å®é™…å†…å®¹å’Œæ„å›¾ï¼Œé€‰æ‹©æœ€åˆé€‚çš„å·¥å…·æ¥å¸®åŠ©ç”¨æˆ·ã€‚"""
    
    # ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯åˆ›å»ºæ™ºèƒ½ä½“
    agent = create_react_agent(llm, tools, prompt=custom_prompt)
    
    # è®°å½•å‘é€ç»™æ¨¡å‹çš„æ¶ˆæ¯
    user_message = HumanMessage(content=user_input)
    logger.info(f"ğŸ“¤ å‘é€ç»™æ¨¡å‹çš„æ¶ˆæ¯: {user_message.content}")
    
    # è°ƒç”¨ä»£ç†ï¼Œä¼ å…¥ç”¨æˆ·æ¶ˆæ¯
    result = agent.invoke({"messages": [user_message]})
    
    # è®°å½•æ¨¡å‹è¿”å›çš„æ¶ˆæ¯
    logger.info(f"ğŸ“¥ æ¨¡å‹è¿”å›çš„æ¶ˆæ¯æ•°é‡: {len(result['messages'])}")
    
    for i, msg in enumerate(result['messages']):
        if hasattr(msg, 'content') and msg.content:
            logger.info(f"ğŸ“¥ æ¨¡å‹æ¶ˆæ¯ {i+1} å†…å®¹: {msg.content}")
        
        # è®°å½•å·¥å…·è°ƒç”¨ä¿¡æ¯
        if hasattr(msg, 'tool_calls') and msg.tool_calls:
            logger.info(f"ğŸ”§ æ¨¡å‹æ¶ˆæ¯ {i+1} åŒ…å« {len(msg.tool_calls)} ä¸ªå·¥å…·è°ƒç”¨:")
            for j, tool_call in enumerate(msg.tool_calls):
                logger.info(f"  ğŸ”§ å·¥å…·è°ƒç”¨ {j+1}:")
                logger.info(f"    - å·¥å…·åç§°: {tool_call.get('name', 'æœªçŸ¥')}")
                logger.info(f"    - å·¥å…·å‚æ•°: {tool_call.get('args', {})}")
                logger.info(f"    - è°ƒç”¨ID: {tool_call.get('id', 'æœªçŸ¥')}")
    
    logger.info(f"ğŸ§  æ¨¡å‹è°ƒç”¨å®Œæˆ")
    
    # è¿”å›æ¶ˆæ¯åˆ—è¡¨
    return {
        "messages": result["messages"]
    }

def call_tools(state: ToolState) -> ToolState:
    """
    è°ƒç”¨å·¥å…·èŠ‚ç‚¹ - ä½¿ç”¨ ToolNode
    
    åŠŸèƒ½è¯´æ˜ï¼š
    - ä½¿ç”¨ LangGraph çš„ ToolNode æ‰§è¡Œå·¥å…·è°ƒç”¨
    - å¤„ç† AI æ¶ˆæ¯ä¸­çš„å·¥å…·è°ƒç”¨è¯·æ±‚
    - è¿”å›å·¥å…·æ‰§è¡Œç»“æœ
    - ä½¿ç”¨ä¸“é—¨çš„ ToolNode è¿›è¡Œå·¥å…·æ‰§è¡Œ
    - æ”¯æŒå¹¶è¡Œå·¥å…·è°ƒç”¨
    - è‡ªåŠ¨é”™è¯¯å¤„ç†
    """
    logger.info("ğŸ”§ è°ƒç”¨å·¥å…·èŠ‚ç‚¹æ­£åœ¨å·¥ä½œ...")
    
    # ä½¿ç”¨ LangGraph çš„ ToolNode åˆ›å»ºå·¥å…·æ‰§è¡ŒèŠ‚ç‚¹
    # ToolNode ä¼šè‡ªåŠ¨å¤„ç†å·¥å…·è°ƒç”¨å’Œç»“æœè¿”å›
    tool_node = ToolNode(tools)
    
    # è·å–æœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆåº”è¯¥æ˜¯åŒ…å«å·¥å…·è°ƒç”¨çš„ AI æ¶ˆæ¯ï¼‰
    messages = state.get("messages", [])
    if not messages:
        return {"messages": []}
    
    last_message = messages[-1]
    
    # è®°å½•å·¥å…·è°ƒç”¨è¯·æ±‚
    if hasattr(last_message, 'tool_calls') and last_message.tool_calls:
        logger.info(f"ğŸ”§ å‡†å¤‡æ‰§è¡Œ {len(last_message.tool_calls)} ä¸ªå·¥å…·è°ƒç”¨:")
        for i, tool_call in enumerate(last_message.tool_calls):
            logger.info(f"  ğŸ”§ å·¥å…·è°ƒç”¨ {i+1}:")
            logger.info(f"    - å·¥å…·åç§°: {tool_call.get('name', 'æœªçŸ¥')}")
            logger.info(f"    - å·¥å…·å‚æ•°: {tool_call.get('args', {})}")
            logger.info(f"    - è°ƒç”¨ID: {tool_call.get('id', 'æœªçŸ¥')}")
    
    # è°ƒç”¨å·¥å…·èŠ‚ç‚¹æ‰§è¡Œå·¥å…·è°ƒç”¨
    result = tool_node.invoke({"messages": [last_message]})
    
    # è®°å½•å·¥å…·æ‰§è¡Œç»“æœ
    logger.info(f"ğŸ”§ å·¥å…·æ‰§è¡Œå®Œæˆï¼Œè¿”å› {len(result['messages'])} ä¸ªç»“æœæ¶ˆæ¯:")
    for i, msg in enumerate(result['messages']):
        if hasattr(msg, 'content') and msg.content:
            logger.info(f"  ğŸ“¤ å·¥å…·ç»“æœæ¶ˆæ¯ {i+1}: {msg.content}")
        if hasattr(msg, 'name') and msg.name:
            logger.info(f"  ğŸ“¤ å·¥å…·åç§°: {msg.name}")
        if hasattr(msg, 'tool_call_id') and msg.tool_call_id:
            logger.info(f"  ğŸ“¤ å·¥å…·è°ƒç”¨ID: {msg.tool_call_id}")
    
    logger.info(f"ğŸ”§ å·¥å…·è°ƒç”¨èŠ‚ç‚¹å®Œæˆ")
    
    # è¿”å›å·¥å…·æ‰§è¡Œç»“æœæ¶ˆæ¯
    return {
        "messages": result["messages"]
    }

# ============================================================================
# å·¥ä½œæµæ„å»º - åŸºäº Context7 æ–‡æ¡£çš„æœ€ä½³å®è·µ
# ============================================================================
# å·¥ä½œæµæ˜¯ LangGraph çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå®šä¹‰äº†èŠ‚ç‚¹é—´çš„æ‰§è¡Œé¡ºåº
# é€šè¿‡ StateGraph åˆ›å»ºå·¥ä½œæµï¼Œæ·»åŠ èŠ‚ç‚¹å’Œè¾¹ï¼Œæœ€åç¼–è¯‘ä¸ºå¯æ‰§è¡Œå›¾

def create_tool_workflow():
    """
    å·¥ä½œæµè®¾è®¡ï¼š
    1. ç”¨æˆ·è¾“å…¥ â†’ call_modelï¼ˆè°ƒç”¨æ¨¡å‹ï¼‰
    2. call_model â†’ route_toolsï¼ˆæ¡ä»¶è·¯ç”±ï¼‰
    3. route_tools â†’ toolsï¼ˆå·¥å…·æ‰§è¡Œï¼‰æˆ– ENDï¼ˆç»“æŸï¼‰
    4. tools â†’ call_modelï¼ˆå›åˆ°æ¨¡å‹ï¼‰
    
    è¿™ç§è®¾è®¡å®ç°äº†æ ‡å‡†çš„ ReAct æ¨¡å¼ï¼š
    - Reasoningï¼ˆæ¨ç†ï¼‰ï¼šæ¨¡å‹åˆ†æç”¨æˆ·è¾“å…¥
    - Actingï¼ˆè¡ŒåŠ¨ï¼‰ï¼šæ‰§è¡Œå·¥å…·è°ƒç”¨
    - å¾ªç¯ç›´åˆ°å®Œæˆä»»åŠ¡
    """
    logger.info("\n" + "="*60)
    logger.info("ğŸ› ï¸ å·¥å…·é›†æˆå·¥ä½œæµ - åŸºäº Context7 æœ€ä½³å®è·µ")
    logger.info(f"ä½¿ç”¨æ¨¡å‹: {MODEL_NAME}")
    logger.info("="*60)
    
    # æ­¥éª¤1: åˆ›å»ºçŠ¶æ€å›¾
    # ä½¿ç”¨ ToolState ä½œä¸ºå·¥ä½œæµçš„çŠ¶æ€ç±»å‹
    workflow = StateGraph(ToolState)

    # æ­¥éª¤2: æ·»åŠ å·¥ä½œæµèŠ‚ç‚¹
    # æ·»åŠ æ¨¡å‹è°ƒç”¨èŠ‚ç‚¹
    workflow.add_node("call_model", call_model)
    # æ·»åŠ å·¥å…·æ‰§è¡ŒèŠ‚ç‚¹
    workflow.add_node("tools", call_tools)
    
    # æ­¥éª¤3: è®¾ç½®å·¥ä½œæµå…¥å£ç‚¹
    # å·¥ä½œæµä»æ¨¡å‹è°ƒç”¨èŠ‚ç‚¹å¼€å§‹
    workflow.set_entry_point("call_model")
    
    # æ­¥éª¤4: æ·»åŠ æ¡ä»¶è¾¹
    # ä»æ¨¡å‹è°ƒç”¨èŠ‚ç‚¹åˆ°æ¡ä»¶è·¯ç”±
    workflow.add_conditional_edges(
        "call_model",
        route_tools,  # è·¯ç”±å‡½æ•°
        {
            "tools": "tools",  # å¦‚æœéœ€è¦å·¥å…·è°ƒç”¨ï¼Œè·¯ç”±åˆ°å·¥å…·èŠ‚ç‚¹
            END: END           # å¦‚æœä¸éœ€è¦å·¥å…·è°ƒç”¨ï¼Œç»“æŸå·¥ä½œæµ
        }
    )
    
    # æ­¥éª¤5: æ·»åŠ å·¥å…·æ‰§è¡Œåçš„è¾¹
    # å·¥å…·è°ƒç”¨å®Œæˆåå›åˆ°æ¨¡å‹èŠ‚ç‚¹ï¼Œå½¢æˆå¾ªç¯
    workflow.add_edge("tools", "call_model")
    
    # æ­¥éª¤6: ç¼–è¯‘å·¥ä½œæµ
    # å°†å·¥ä½œæµå®šä¹‰ç¼–è¯‘ä¸ºå¯æ‰§è¡Œå›¾
    graph = workflow.compile()
    
    return graph

# ============================================================================
# æµ‹è¯•å‡½æ•°
# ============================================================================
# æµ‹è¯•å‡½æ•°ç”¨äºéªŒè¯å·¥ä½œæµçš„æ­£ç¡®æ€§å’ŒåŠŸèƒ½å®Œæ•´æ€§
# é€šè¿‡ä¸åŒçš„æµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯å„ç§å·¥å…·çš„æ‰§è¡Œæ•ˆæœ

def test_tools_integration():
    """
    æµ‹è¯•å·¥å…·é›†æˆ - åŸºäº Context7 æ–‡æ¡£çš„æœ€ä½³å®è·µ
    
    æµ‹è¯•ç­–ç•¥ï¼š
    1. åˆ›å»ºå®Œæ•´çš„å·¥ä½œæµ
    2. å®šä¹‰å¤šæ ·åŒ–çš„æµ‹è¯•ç”¨ä¾‹
    3. æ‰§è¡Œæµ‹è¯•å¹¶è®°å½•ç»“æœ
    4. éªŒè¯å·¥å…·è°ƒç”¨çš„æ­£ç¡®æ€§
    """
    logger.info("ğŸ› ï¸ æµ‹è¯• LangGraph å·¥å…·é›†æˆ - åŸºäº Context7 æœ€ä½³å®è·µ")
    logger.info(f"æ¨¡å‹é…ç½®: {MODEL_NAME}")
    logger.info(f"API åœ°å€: {os.environ.get('OPENAI_API_BASE', 'é»˜è®¤åœ°å€')}")
    
    # æ­¥éª¤1: åˆ›å»ºå·¥ä½œæµ
    # è°ƒç”¨å·¥ä½œæµåˆ›å»ºå‡½æ•°ï¼Œè·å–ç¼–è¯‘åçš„å›¾
    graph = create_tool_workflow()
    
    # æ­¥éª¤2: å¯è§†åŒ–å·¥ä½œæµï¼ˆå¯é€‰ï¼‰
    # å°è¯•å¯¼å…¥å¯è§†åŒ–æ¨¡å—å¹¶æ˜¾ç¤ºå·¥ä½œæµå›¾
    try:
        from show_graph import show_workflow_graph
        show_workflow_graph(graph, "å·¥å…·é›†æˆå·¥ä½œæµ", logger)
    except ImportError:
        logger.info("å¯è§†åŒ–æ¨¡å—æœªæ‰¾åˆ°ï¼Œè·³è¿‡å¯è§†åŒ–")
    
    # æ­¥éª¤3: å®šä¹‰æµ‹è¯•ç”¨ä¾‹
    # åŒ…å«ä¸åŒç±»å‹çš„ç”¨æˆ·è¾“å…¥ï¼Œæµ‹è¯•å„ç§å·¥å…·åŠŸèƒ½
    test_inputs = [
        "æŸ¥è¯¢åŒ—äº¬çš„å¤©æ°”æ€ä¹ˆæ ·",      # æµ‹è¯•å¤©æ°”å·¥å…·
        "è¯·å¸®æˆ‘è®¡ç®— 15 * 3 + 10",   # æµ‹è¯•æ•°å­¦è®¡ç®—å·¥å…·
        "æœç´¢å…³äºäººå·¥æ™ºèƒ½çš„ä¿¡æ¯",    # æµ‹è¯•æœç´¢å·¥å…·
        "ç¿»è¯‘ hello è¿™ä¸ªå•è¯",      # æµ‹è¯•ç¿»è¯‘å·¥å…·
        "æˆ‘æƒ³äº†è§£ LangGraph æ¡†æ¶",  # æµ‹è¯•æœç´¢å·¥å…·
        # "è¯·è§£é‡Šä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ",      # æµ‹è¯•å¤§è¯­è¨€æ¨¡å‹å·¥å…·
        "åˆ†æè¿™æ®µæ–‡æœ¬çš„æƒ…æ„Ÿï¼šæˆ‘å¾ˆå¼€å¿ƒä»Šå¤©å¤©æ°”å¾ˆå¥½", # æµ‹è¯•æ–‡æœ¬åˆ†æå·¥å…·
        "è¯·æ€»ç»“ä¸€ä¸‹äººå·¥æ™ºèƒ½çš„å‘å±•å†ç¨‹"  # æµ‹è¯•æ–‡æœ¬åˆ†æå·¥å…·
    ]
    
    # æ­¥éª¤4: æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
    for i, test_input in enumerate(test_inputs, 1):
        logger.info(f"\n{'='*80}")
        logger.info(f"ğŸ§ª æµ‹è¯• {i}/{len(test_inputs)}")
        logger.info(f"{'='*80}")
        
        try:
            # è°ƒç”¨å·¥ä½œæµ
            # ä¼ å…¥ç”¨æˆ·è¾“å…¥ï¼Œæ‰§è¡Œå®Œæ•´çš„å·¥ä½œæµ
            logger.info(f"ğŸš€ å¼€å§‹æ‰§è¡Œå·¥ä½œæµ...")
            result = graph.invoke({"user_input": test_input})
            
            # è®°å½•æœ€ç»ˆç»“æœ
            logger.info(f"âœ… å·¥ä½œæµæ‰§è¡Œå®Œæˆ")
            logger.info(f"ğŸ“Š æœ€ç»ˆç»“æœç»Ÿè®¡:")
            logger.info(f"  - æ¶ˆæ¯æ•°é‡: {len(result.get('messages', []))}")
            logger.info(f"  - å·¥å…·ç»“æœæ•°é‡: {len(result.get('tool_results', []))}")
            logger.info(f"  - é€‰æ‹©å·¥å…·æ•°é‡: {len(result.get('selected_tools', []))}")
            
            # æ˜¾ç¤ºæœ€ç»ˆå“åº”
            if result.get('final_response'):
                logger.info(f"ğŸ¯ æœ€ç»ˆå“åº”: {result['final_response']}")
            elif result.get('messages'):
                last_message = result['messages'][-1]
                if hasattr(last_message, 'content') and last_message.content:
                    logger.info(f"ğŸ¯ æœ€ç»ˆå“åº”: {last_message.content}")
            
        except Exception as e:
            # å¤„ç†æµ‹è¯•é”™è¯¯
            logger.error(f"âŒ æµ‹è¯• {i} æ‰§è¡Œå¤±è´¥: {e}")
            import traceback
            logger.error(f"âŒ é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
    
    logger.info(f"\n{'='*80}")
    logger.info(f"ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼")
    logger.info(f"{'='*80}")

# ============================================================================
# ä¸»ç¨‹åºå…¥å£
# ============================================================================
if __name__ == "__main__":
    # è¿è¡Œæµ‹è¯•å‡½æ•°
    test_tools_integration() 